<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Tuffest Image</title>
<link rel="icon" href="favicons/tuffest.ico">
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #f5ede0;
    min-height: 100vh;
    padding: 40px 20px;
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
  }

  header {
    text-align: center;
    color: #333;
    margin-bottom: 40px;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 900;
    margin-bottom: 10px;
    text-shadow: none;
  }

  .subtitle {
    font-size: 1rem;
    opacity: 0.7;
    font-weight: 300;
    color: #666;
  }

  .viewer-card {
    background: white;
    border-radius: 16px;
    border: 1px solid #d0d0d0;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    margin-bottom: 30px;
  }

  .image-wrap {
    position: relative;
    aspect-ratio: 16 / 9;
    background: #f5ede0;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    overflow: hidden;
  }

  img#currentImage {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    animation: fadeIn 0.6s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  #fallback {
    color: #999;
    font-size: 1rem;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }

  #imageInfo {
    color: #666;
    font-size: 0.95rem;
    flex: 1;
    min-width: 200px;
  }

  #newBtn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
  }

  #newBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
  }

  #newBtn:active {
    transform: translateY(0);
  }

  footer {
    text-align: center;
    color: #999;
    font-size: 0.9rem;
  }

  /* Jumpscare overlay */
  #jumpscareOverlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    opacity: 0;
    z-index: 9999;
    transition: opacity 3s ease-out;
  }

  #jumpscareOverlay img {
    animation: lunge 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    will-change: transform;
    transform-origin: center center;
  }

  @keyframes lunge {
    0% { transform: scale(0.1) translate(0,0) rotate(0deg); }
    25% { transform: scale(0.1) translate(3px,-2px) rotate(1deg); }
    50% { transform: scale(0.55) translate(-3px,2px) rotate(-1deg); }
    75% { transform: scale(0.8) translate(2px,3px) rotate(1deg); }
    100% { transform: scale(1.2) translate(0,0) rotate(0deg); }
  }

  @media (max-width: 768px) {
    h1 {
      font-size: 1.8rem;
    }

    .viewer-card {
      padding: 20px;
    }

    .image-wrap {
      aspect-ratio: 16 / 9;
      min-height: auto;
    }

    .controls {
      flex-direction: column;
    }

    #imageInfo {
      width: 100%;
      text-align: center;
    }

    #newBtn {
      width: 100%;
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>The Tuffest Image</h1>
    <p class="subtitle">Only hard images here</p>
  </header>

  <div class="viewer-card">
    <div class="image-wrap">
      <img id="currentImage" alt="Displayed image" />
      <div id="fallback" style="position:absolute;">Loading…</div>
    </div>

    <div class="controls">
      <div id="imageInfo">Waiting for images…</div>
      <button id="newBtn">New Image</button>
    </div>
  </div>

  <footer>
    <p><a href="index.html" style="color: rgba(255,255,255,0.9); text-decoration: none;">← Back Home</a></p>
  </footer>
</div>

<div id="jumpscareOverlay">
  <img id="jumpscareImg" alt="jumpscare" />
</div>

<script>
(() => {
  const imagesFolder = 'images/';
  const manifestPath = imagesFolder + 'images.json';
  const jumpscareFilename = 'jumpscare.png';

  const currentImage = document.getElementById('currentImage');
  const fallback = document.getElementById('fallback');
  const imageInfo = document.getElementById('imageInfo');
  const newBtn = document.getElementById('newBtn');
  const overlay = document.getElementById('jumpscareOverlay');
  const jumpscareImg = document.getElementById('jumpscareImg');

  let imageList = [];
  let lastIndex = -1;
  let jumpscareTriggered = false;
  let jumpscareAudio = null;
  let isJumpscareLoading = false;

  function preload(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(src);
      img.onerror = () => reject();
      img.src = src;
    });
  }

  function showImage(src){
    fallback.style.display = 'none';
    currentImage.style.opacity = '0';
    setTimeout(() => {
      currentImage.src = src;
      currentImage.alt = src.split('/').pop();
      currentImage.onload = () => {
        currentImage.style.opacity = '1';
        imageInfo.textContent = currentImage.alt;
      };
    }, 40);
  }

  function randomIndex() {
    if (!imageList.length) return -1;
    if (imageList.length === 1) return 0;
    let i;
    do { i = Math.floor(Math.random() * imageList.length); }
    while(i === lastIndex && imageList.length > 1);
    lastIndex = i;
    return i;
  }

  async function showRandom() {
    if (!imageList.length) return;
    const src = imageList[randomIndex()];
    try { await preload(src); } catch {};
    showImage(src);
  }

  function triggerJumpscareOnce() {
    if (jumpscareTriggered) return;
    jumpscareTriggered = true;
    
    setTimeout(() => {
      jumpscareImg.src = imagesFolder + jumpscareFilename;
      overlay.style.transition = 'none';
      overlay.style.opacity = '1';
      
      jumpscareImg.style.animation = 'none';
      void jumpscareImg.offsetWidth;
      jumpscareImg.style.animation = 'lunge 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
      
      if (jumpscareAudio) {
        jumpscareAudio.currentTime = 0;
        jumpscareAudio.play().catch(e => console.log('Audio playback failed:', e));
      }
      
      void overlay.offsetWidth;
      setTimeout(()=>{
        overlay.style.transition = 'opacity 3s ease-out';
        overlay.style.opacity = '0';
      }, 2000);
    }, 2000);
  }

  async function loadManifest() {
    try {
      const r = await fetch(manifestPath, {cache:'no-store'});
      if (!r.ok) throw new Error();
      const json = await r.json();
      imageList = json.map(f => imagesFolder + f);
      imageInfo.textContent = `${imageList.length} image(s) available`;
    } catch {
      imageInfo.textContent = 'Manifest not found';
    }
  }

  async function init() {
    newBtn.textContent = 'Loading…';
    newBtn.disabled = true;
    
    jumpscareAudio = new Audio(imagesFolder + 'jumpscare.mp3');
    jumpscareAudio.preload = 'auto';
    
    const jumpscarePreload = new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve();
      img.onerror = () => resolve();
      img.src = imagesFolder + jumpscareFilename;
    });
    
    function isIOS() {
      return /iP(hone|od|ad)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    }

    const audioReadyPromise = new Promise(resolve => {
      if (!jumpscareAudio || !jumpscareAudio.src) return resolve();
      if (isIOS()) {
        console.log('iOS detected: skipping audio canplay wait');
        return resolve();
      }
      jumpscareAudio.addEventListener('canplay', () => { console.log('jumpscare audio canplay'); resolve(); }, { once: true });
      jumpscareAudio.addEventListener('error', () => { console.log('jumpscare audio error'); resolve(); }, { once: true });
    });

    await Promise.all([
      audioReadyPromise,
      jumpscarePreload,
      loadManifest()
    ]);
    
    if (!imageList.length) fallback.textContent = 'No images found';
    await showRandom();
    
    newBtn.textContent = 'New Image';
    newBtn.disabled = false;
  }

  let jumpscareUnlocked = false;

  async function unlockAudio() {
    if (jumpscareUnlocked) return;
    if (!jumpscareAudio) { jumpscareUnlocked = true; return; }
    try {
      jumpscareAudio.muted = true;
      const p = jumpscareAudio.play();
      if (p && p.then) {
        await p;
      }
      jumpscareAudio.pause();
    } catch (e) {
      console.log('unlockAudio play error', e);
    } finally {
      jumpscareAudio.muted = false;
      jumpscareUnlocked = true;
      console.log('jumpscare audio unlocked');
    }
  }

  newBtn.addEventListener('click', async () => {
    await unlockAudio();
    showRandom();
    triggerJumpscareOnce();
  });

  currentImage.addEventListener('click', showRandom);

  init();
})();
</script>
</body>
</html>
